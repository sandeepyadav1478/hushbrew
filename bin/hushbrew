#!/bin/bash
#
# hushbrew — Main command dispatcher
#
# Usage:
#   hushbrew setup   - Complete installation setup
#   hushbrew start   - Start the service
#   hushbrew stop    - Stop the service
#   hushbrew status  - Show service status
#   hushbrew logs    - View logs
#   hushbrew run     - Run upgrade manually
#

set -euo pipefail

VERSION="1.0.1"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find where Homebrew installed hushbrew
if [ -d "/opt/homebrew/opt/hushbrew/libexec" ]; then
    LIBEXEC="/opt/homebrew/opt/hushbrew/libexec"
elif [ -d "/usr/local/opt/hushbrew/libexec" ]; then
    LIBEXEC="/usr/local/opt/hushbrew/libexec"
else
    LIBEXEC=""
fi

cmd_setup() {
    if [ -z "$LIBEXEC" ]; then
        echo -e "${RED}Error: Cannot find hushbrew installation${NC}" >&2
        echo "Please run: brew install sandeepyadav1478/hushbrew/hushbrew" >&2
        exit 1
    fi

    # Run setup script
    "$LIBEXEC/hushbrew-setup"
}

cmd_start() {
    # Check if setup is needed
    if [ ! -f "$HOME/.local/bin/hushbrew.sh" ] || \
       [ ! -f "$HOME/.config/hushbrew/config" ] || \
       [ ! -f "$HOME/Library/LaunchAgents/com.local.hushbrew.plist" ]; then
        echo -e "${BLUE}First run detected - setting up hushbrew...${NC}"
        echo ""
        cmd_setup
        setup_exit_code=$?
        if [ $setup_exit_code -ne 0 ]; then
            echo -e "${RED}Setup failed with exit code: $setup_exit_code${NC}" >&2
            exit $setup_exit_code
        fi
        echo ""
    fi

    echo -e "${BLUE}Starting hushbrew...${NC}"

    # Use our custom plist with calendar-based scheduling (not brew services)
    launchctl bootstrap "gui/$(id -u)" "$HOME/Library/LaunchAgents/com.local.hushbrew.plist" 2>/dev/null
    load_exit=$?

    if [ $load_exit -eq 0 ]; then
        echo -e "${GREEN}✓ hushbrew started${NC}"
        echo ""
        echo "Schedule: 10 AM, 2 PM, 6 PM daily"
        echo "Logs:     tail -f ~/.local/log/hushbrew.log"
        echo ""
        echo "Commands:"
        echo "  hushbrew status  - Check status"
        echo "  hushbrew logs    - View logs"
        echo "  hushbrew stop    - Stop service"
    elif [ $load_exit -eq 37 ] || [ $load_exit -eq 17 ]; then
        echo -e "${YELLOW}Already running${NC}"
    else
        echo -e "${RED}Failed to start (exit code: $load_exit)${NC}" >&2
        exit $load_exit
    fi
}

cmd_stop() {
    echo -e "${BLUE}Stopping hushbrew...${NC}"

    # Unload our custom LaunchAgent
    launchctl bootout "gui/$(id -u)/com.local.hushbrew" 2>/dev/null
    stop_exit=$?

    # Also stop brew services version if it's running
    brew services stop hushbrew 2>/dev/null || true

    if [ $stop_exit -eq 0 ] || [ $stop_exit -eq 3 ]; then
        echo -e "${GREEN}✓ hushbrew stopped${NC}"
    else
        echo -e "${YELLOW}hushbrew was not running${NC}"
    fi
}

cmd_status() {
    echo -e "${BLUE}hushbrew status:${NC}"
    echo ""

    # Check if files exist
    if [ -f "$HOME/.local/bin/hushbrew.sh" ]; then
        echo -e "${GREEN}✓${NC} Scripts installed"
    else
        echo -e "${RED}✗${NC} Scripts not installed (run: hushbrew setup)"
    fi

    if [ -f "$HOME/.config/hushbrew/config" ]; then
        echo -e "${GREEN}✓${NC} Config exists"
    else
        echo -e "${RED}✗${NC} Config missing"
    fi

    if [ -f "$HOME/Library/LaunchAgents/com.local.hushbrew.plist" ]; then
        echo -e "${GREEN}✓${NC} LaunchAgent plist installed"
    else
        echo -e "${RED}✗${NC} LaunchAgent plist missing"
    fi

    # Check if service is loaded
    if launchctl list 2>/dev/null | grep -q "com.local.hushbrew"; then
        exit_code=$(launchctl list 2>/dev/null | grep "com.local.hushbrew" | awk '{print $1}')
        if [ "$exit_code" = "-" ] || [ "$exit_code" = "0" ]; then
            echo -e "${GREEN}✓${NC} Service is running"
        else
            echo -e "${YELLOW}⚠${NC} Service loaded but exited with code: $exit_code"
        fi
    else
        echo -e "${YELLOW}○${NC} Service is not loaded"
    fi

    # Check last run
    if [ -f "$HOME/.local/log/hushbrew.lastrun" ]; then
        last_run=$(cat "$HOME/.local/log/hushbrew.lastrun")
        echo ""
        echo "Last run: $last_run"
    fi

    # Check if log exists
    if [ -f "$HOME/.local/log/hushbrew.log" ]; then
        log_size=$(du -h "$HOME/.local/log/hushbrew.log" | cut -f1)
        echo "Log file: ~/.local/log/hushbrew.log ($log_size)"
    fi
}

cmd_logs() {
    if [ -f "$HOME/.local/log/hushbrew.log" ]; then
        if [ "${1:-}" = "-f" ] || [ "${1:-}" = "--follow" ]; then
            tail -f "$HOME/.local/log/hushbrew.log"
        else
            tail -50 "$HOME/.local/log/hushbrew.log"
        fi
    else
        echo -e "${YELLOW}No log file found yet${NC}"
        echo "Log will be created at: ~/.local/log/hushbrew.log"
    fi
}

cmd_run() {
    if [ -f "$HOME/.local/bin/hushbrew.sh" ]; then
        echo -e "${BLUE}Running hushbrew manually...${NC}"
        "$HOME/.local/bin/hushbrew.sh"
    else
        echo -e "${RED}Error: hushbrew not set up${NC}" >&2
        echo "Run: hushbrew setup" >&2
        exit 1
    fi
}

cmd_help() {
    cat <<EOF
hushbrew v${VERSION} - Automatic Homebrew upgrades for macOS

Usage:
  hushbrew start          Start the service (runs setup if needed)
  hushbrew stop           Stop the service
  hushbrew status         Show service status
  hushbrew logs [-f]      View logs (-f to follow)
  hushbrew run            Run upgrade manually
  hushbrew setup          Run setup manually (usually not needed)
  hushbrew help           Show this help
  hushbrew version        Show version

Quick Start:
  brew install sandeepyadav1478/hushbrew/hushbrew
  hushbrew start

Features:
  • Runs at 10 AM, 2 PM, 6 PM daily
  • Meeting-aware (Zoom, Slack, mic detection)
  • Power-aware (skips if battery <15%)
  • Bandwidth throttling (60% of detected speed)

Configuration:
  Edit ~/.config/hushbrew/config to exclude packages

Documentation:
  https://github.com/sandeepyadav1478/hushbrew
EOF
}

cmd_version() {
    echo "hushbrew v${VERSION}"
}

# Main command dispatcher
case "${1:-}" in
    setup)
        cmd_setup
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    logs)
        shift
        cmd_logs "$@"
        ;;
    run)
        cmd_run
        ;;
    help|--help|-h)
        cmd_help
        ;;
    version|--version|-v)
        cmd_version
        ;;
    "")
        echo -e "${RED}Error: No command specified${NC}" >&2
        echo "" >&2
        cmd_help >&2
        exit 1
        ;;
    *)
        echo -e "${RED}Error: Unknown command: $1${NC}" >&2
        echo "" >&2
        cmd_help >&2
        exit 1
        ;;
esac
